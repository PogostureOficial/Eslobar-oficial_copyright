<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat con IA</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <!-- Título inicial -->
  <div id="titulo">¿En qué puedo ayudarte hoy?</div>

  <!-- Contenedor del chat -->
  <div id="chat" class="chat-box"></div>

  <!-- Entrada de texto y botón -->
  <div class="input-container">
    <textarea 
      id="mensaje" 
      rows="1" 
      placeholder="Pregunta lo que quieras..." 
      onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();enviarMensaje()}"
    ></textarea>

    <div class="voice-btn" id="voiceBtn" aria-hidden="true">
      <img src="button1.png" id="btn1" class="initial-visible" alt="Micrófono">
      <img src="button2.png" id="btn2" class="initial-hidden" alt="Enviar">
    </div>
  </div>

  <!-- Botón solo para alternar vista PC/Móvil (simulación) -->
<button id="toggleViewBtn" style="position:fixed;top:10px;right:10px;z-index:999;">
  Alternar vista
</button>

  <script>
    /* =========================================================
       VARIABLES GLOBALES
    ========================================================= */
    const input = document.getElementById('mensaje');
    const chat = document.getElementById("chat");
    const titulo = document.getElementById("titulo");
    const btn1 = document.getElementById('btn1'); // mic
    const btn2 = document.getElementById('btn2'); // enviar

    let animBtn1 = null, animBtn2 = null;
    let previousHasText = false;
    const D = 250; // duración animaciones
    const easing = 'cubic-bezier(.22,1,.36,1)';

    /* =========================================================
       UTILIDADES
    ========================================================= */
    function parseBold(text) {
      return text.replace(/\*(.*?)\*/g, '<b>$1</b>');
    }

    function addBotMessage() {
      const botMsg = document.createElement("div");
      botMsg.className = "message bot";
      chat.appendChild(botMsg);
      return botMsg;
    }

    function typeWriterEffect(container, text = '', speed = 15) {
      return new Promise((resolve) => {
        if (!text) return resolve();

        const parsed = parseBold(text);
        let i = 0;
        const interval = setInterval(() => {
          container.innerHTML = parsed.slice(0, i + 1);
          if (container.parentElement) {
            container.parentElement.scrollTop = container.parentElement.scrollHeight;
          }
          if (++i >= parsed.length) {
            clearInterval(interval);
            resolve();
          }
        }, speed);
      });
    }

    /* =========================================================
       ANIMACIONES BOTONES (mic/enviar)
    ========================================================= */
    function cancelAnimsAndFreeze() {
      [btn1, btn2].forEach((btn, idx) => {
        let anim = idx === 0 ? animBtn1 : animBtn2;
        if (anim) {
          anim.cancel();
          if (idx === 0) animBtn1 = null; else animBtn2 = null;
          const cs = getComputedStyle(btn);
          btn.style.transform = cs.transform === 'none' ? 'scale(1)' : cs.transform;
          btn.style.opacity = cs.opacity;
        }
      });
    }

    function transitionToBtn2() {
      cancelAnimsAndFreeze();
      btn1.style.visibility = 'visible';
      animBtn1 = btn1.animate(
        [{ transform: 'scale(1)', opacity: 1 }, { transform: 'scale(0)', opacity: 0 }],
        { duration: D, easing, fill: 'forwards' }
      );

      animBtn1.onfinish = () => {
        btn1.style.visibility = 'hidden';
        btn2.style.visibility = 'visible';
        animBtn2 = btn2.animate(
          [{ transform: 'scale(0)', opacity: 0 }, { transform: 'scale(1)', opacity: 1 }],
          { duration: D, easing, fill: 'forwards' }
        );
      };
    }

    function transitionToBtn1() {
      cancelAnimsAndFreeze();
      btn2.style.visibility = 'visible';
      animBtn2 = btn2.animate(
        [{ transform: 'scale(1)', opacity: 1 }, { transform: 'scale(0)', opacity: 0 }],
        { duration: D, easing, fill: 'forwards' }
      );

      animBtn2.onfinish = () => {
        btn2.style.visibility = 'hidden';
        btn1.style.visibility = 'visible';
        animBtn1 = btn1.animate(
          [{ transform: 'scale(0)', opacity: 0 }, { transform: 'scale(1)', opacity: 1 }],
          { duration: D, easing, fill: 'forwards' }
        );
      };
    }

    /* =========================================================
       EVENTOS
    ========================================================= */
    input.addEventListener('input', () => {
      const hasText = input.value.trim() !== '';
      if (hasText && !previousHasText) transitionToBtn2();
      else if (!hasText && previousHasText) transitionToBtn1();
      previousHasText = hasText;

      // auto expand textarea
      input.style.height = "auto";
      input.style.height = input.scrollHeight + "px";
      document.querySelector(".input-container")
        .classList.toggle("expanded", input.scrollHeight > input.clientHeight);
    });

    if (window.visualViewport) {
  // Cuando aparece o desaparece el teclado, ajustamos la altura
  window.visualViewport.addEventListener('resize', ajustarAlturaMovil);
  window.visualViewport.addEventListener('scroll', ajustarAlturaMovil);
}

document.getElementById("btn2").addEventListener("click", function () {
  enviarMensaje(); // usamos la función correcta
});



    /* =========================================================
       MENSAJES
    ========================================================= */
    async function enviarMensaje() {
      const userText = input.value.trim();
      if (!userText) return;

      // Ocultar título y agregar mensaje usuario
      titulo.style.opacity = 0;
      const userMsg = document.createElement("div");
      userMsg.className = "message user";
      userMsg.innerHTML = parseBold(userText);
      chat.appendChild(userMsg);

      // reset input
      input.value = "";
      input.style.height = "auto";
      transitionToBtn1();
      previousHasText = false;

      // Loading
      const loadingMsg = document.createElement("div");
      loadingMsg.className = "message bot loading";
      loadingMsg.innerHTML = `<span></span>
        <video src="anim1.mp4" autoplay loop muted playsinline width="40"></video>`;
      chat.appendChild(loadingMsg);
      chat.scrollTop = chat.scrollHeight;

     // =============================
// Llamada a Hugging Face API (prueba rápida)
// =============================
const HF_TOKEN = "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"; // tu token de Hugging Face

try {
  const response = await fetch(
    "https://api-inference.huggingface.co/models/distilgpt2",
    {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${HF_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ inputs: userText })
    }
  );

  if (!response.ok) {
    if (chat.contains(loadingMsg)) chat.removeChild(loadingMsg);
    const botMsg = addBotMessage();
    await typeWriterEffect(botMsg, `Error ${response.status}: ${response.statusText}`, 15);
    return;
  }

  const data = await response.json().catch(() => null);
  if (chat.contains(loadingMsg)) chat.removeChild(loadingMsg);

  // Hugging Face devuelve un array con "generated_text"
  const reply = data?.[0]?.generated_text || "No hubo respuesta de la IA.";
  const botMsg = addBotMessage();
  await typeWriterEffect(botMsg, reply, 15);

} catch (error) {
  if (chat.contains(loadingMsg)) chat.removeChild(loadingMsg);
  const botMsg = addBotMessage();
  await typeWriterEffect(botMsg, "Error al conectar con la IA: " + error.message, 15);
}
    }

    /* =========================================================
   UTILIDADES EXTRA: Ajuste dinámico en móviles
========================================================= */
function ajustarAlturaMovil() {
  if (window.visualViewport) {
    const vh = window.visualViewport.height; 
    document.body.style.height = vh + 'px';
  }
}

const toggleBtn = document.getElementById("toggleViewBtn");
  if (toggleBtn) {
    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("modo-celular");
    });
  }

  </script>
</body>
</html>
